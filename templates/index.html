<html>

<head>
    <title>Multi-Layered Data Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
</head>

<body>
    <div style="text-align: center; margin: 50px;">
        <h2>Homework 1</h2>

        <h1>Do publicly or privately owned trees have a greater diameter at breast height?</h1>
        <h4>Comparing the distribution of publicly owned and privately owned trees</h4>
    </div>

    <div>
        <div style="display:flex;">
            <div>
                <svg id="legend" width="300" height="170" style="margin-left:150px"></svg>
            </div>

            <span>
                <svg id="sfmap" height="800" width="800" style="margin-bottom: 200px; margin-left:50px;"> </svg>
            </span>
        </div>

        <div style="text-align: center; margin: 50px;">
            <h3>Comparing the average DBH of trees that are publicly owned (DPW) and privately owned separated by species</h3>
            <h4>* only the top 6 most common tree species are displayed *</h4>

        </div>

        <div style="margin: 100px">
            <svg id="first" height="400" width="350" style="margin-right: 50px; margin-left:170px"> </svg>
            <svg id="second" height="400" width="350"></svg>
            <svg id="third" height="400" width="350" style="margin-left: 50px; margin-right: 100px"> </svg>
        </div>

        <div style="margin: 100px">
            <svg id="fourth" height="400" width="350" style="margin-right: 50px; margin-left:170px"> </svg>
            <svg id="fifth" height="400" width="350"></svg>
            <svg id="sixth" height="400" width="350" style="margin-left: 50px; margin-right: 100px"> </svg>
        </div>


        <script>
            var svgLegend = d3.select("svg#legend");

            var legendX = 50;
            var legendY = 20;
            var legendBoxWidth = 250;
            var legendBoxHeight = 150;

            //map legend
            svgLegend.append("rect")
                .attr("x", legendX)
                .attr("y", legendY)
                .attr("width", legendBoxWidth)
                .attr("height", legendBoxHeight)
                .style("fill", "none")
                .style("stroke", "black");

            svgLegend.append("text")
                .attr("x", legendX + 10)
                .attr("y", legendY + 20)
                .text("Legend")
                .style("font-size", "20px")
                .style("font-weight", "bold")
                .attr("alignment-baseline", "middle");

            svgLegend.append("circle")
                .attr("cx", legendX + 20)
                .attr("cy", legendY + 60)
                .attr("r", 8)
                .style("fill", "purple");

            svgLegend.append("text")
                .attr("x", legendX + 40)
                .attr("y", legendY + 60)
                .text("Public Owned Trees (DPW)")
                .style("font-size", "15px")
                .style("font-weight", "bold")
                .attr("alignment-baseline", "middle");

            svgLegend.append("circle")
                .attr("cx", legendX + 20)
                .attr("cy", legendY + 90)
                .attr("r", 8)
                .style("fill", "forestgreen");

            svgLegend.append("text")
                .attr("x", legendX + 40)
                .attr("y", legendY + 90)
                .text("Private Owned Trees")
                .style("font-size", "15px")
                .style("font-weight", "bold")
                .attr("alignment-baseline", "middle");

            svgLegend.append("text")
                .attr("x", legendX + 20)
                .attr("y", legendY + 130)
                .text("Circle size is relative to DBH")
                .style("font-size", "15px")
                .style("font-weight", "bold");


            const svgMap = d3.select("#sfmap");
            const width = svgMap.attr("width");
            const height = svgMap.attr("height");
            const margin = { top: 10, right: 10, bottom: 10, left: 10 };
            const mapWidth = width - margin.left - margin.right;
            const mapHeight = height - margin.top - margin.bottom;
            const map = svgMap.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            const requestData = async function () {

                const sfMap = await d3.json("./static/SF-Neighborhoods.geo.json");

                var neighborhoods = topojson.feature(sfMap, sfMap.objects.SFNeighborhoods);

                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], neighborhoods);
                var path = d3.geoPath().projection(projection);

                map.selectAll("path.neighborhood").data(neighborhoods.features)
                    .join("path")
                    .attr("class", "neighborhood")
                    .attr("d", path)
                    .attr("fill", "lightgray")
                    .attr("stroke", "white")
                    .attr("stroke-width", 1);


                const trees = await d3.csv("./static/Street_Tree_List-2022-01-30_FILTERED.csv");
                
                trees.forEach(row => {
                    row.qSpecies = row.qSpecies.split('::')[0].trim();
                })

                //figure out the most common trees in the dataset
                let treeCounts = {};

                trees.forEach(row => {
                    let treeType = row.qSpecies;
                    if (treeCounts[treeType]) {
                        treeCounts[treeType]++;
                    } else {
                        treeCounts[treeType] = 1;
                    }
                });

                let sortedTrees = Object.entries(treeCounts).sort((a, b) => b[1] - a[1]);
                //take the first 6 most common trees
                let mostCommonTrees = sortedTrees.slice(0, 6);

                //plot a circle for each tree that exists in the dataset 
                //green circle for privately owned trees & purple circle for DPW trees (caretakers)
                trees.forEach(d => {
                    d.Position = projection([d.Longitude, d.Latitude]);
                    d.Color = d.qCaretaker === "Private" ? "forestgreen" : "purple";

                    map.append('circle')
                        .attr('cx', d.Position[0])
                        .attr('cy', d.Position[1])
                        .attr('r', d.DBH * .2) 
                        .style('fill', d.Color)
                        .attr('opacity', 0.15);

                });

                //draw bar graph that compares DBH average between public and private trees for each of the 6 most common trees
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[0][0]), 'svg#first', 0);
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[1][0]), 'svg#second', 1);
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[2][0]), 'svg#third', 2);
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[3][0]), 'svg#fourth', 3);
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[4][0]), 'svg#fifth', 4);
                drawAverageGraph(trees.filter(d => d.qSpecies === mostCommonTrees[5][0]), 'svg#sixth', 5);

                function drawAverageGraph(data, container, index) {

                    const svgGraph = d3.select(container);
                    const margins = { top: 10, right: 20, bottom: 20, left: 30 };

                    const width = svgGraph.attr('width');
                    const height = svgGraph.attr('height');
                    const chartWidth = width - margins.left - margins.right;
                    const chartHeight = height - margins.top - margins.bottom;
                    const chartArea = svgGraph.append('g')
                        .attr('transform', `translate(${margins.left},${margins.top})`);


                    const privateTrees = data.filter(d => d.qCaretaker === 'Private');
                    const publicTrees = data.filter(d => d.qCaretaker === 'DPW');

                    const averagePrivateDBH = d3.mean(privateTrees, d => d.DBH);  
                    const averagePublicDBH = d3.mean(publicTrees, d => d.DBH);

                    const title = data[0].qSpecies;
                    const max = averagePrivateDBH >= averagePublicDBH ? Math.round(averagePrivateDBH + 3) : Math.round(averagePublicDBH + 3);

                    const xExtent = d3.extent(data, d => d.qCaretaker);
                    const xScale = d3.scaleBand()
                        .domain(["Public (DPW)", "Private"])
                        .range([0, chartWidth]);

                    const yExtent = d3.extent(data, d => d.DBH);
                    const yScale = d3.scaleLinear()
                        .domain([0, max])
                        .range([chartHeight, 60]);;

                    let titleText = chartArea.append("text")
                        .attr("x", (chartWidth / 2))
                        .attr("y", 0 + (margin.top))
                        .attr("text-anchor", "middle")
                        .style("font-size", "16px")
                        .style("font-weight", "bold");

                    titleText.append("tspan")
                        .attr("x", (chartWidth / 2))
                        .attr("dy", ".1em")
                        .text("Average DBH for ");

                    titleText.append("tspan")
                        .attr("x", (chartWidth / 2))
                        .attr("dy", "1.25em")
                        .text(title)
                        .style("text-decoration", "underline");

                    titleText.append("tspan")
                        .attr("x", (chartWidth / 2))
                        .attr("dy", "1.5em")
                        .text(`count: ${mostCommonTrees[index][1]}`);


                    let leftAxis = d3.axisLeft(yScale);
                    chartArea.append('g')
                        .attr('class', 'y axis')
                        .attr('transform', `translate(${margins.left - 10}, ${margins.top - 20})`)
                        .call(leftAxis);

                    let bottomAxis = d3.axisBottom(xScale)
                    chartArea.append('g')
                        .attr('class', 'x axis')
                        .attr('transform', `translate(${margins.left}, ${chartHeight})`)
                        .call(bottomAxis);

                    chartArea.append("line")
                        .attr("x1", xScale("Private") + xScale.bandwidth() / 2 + margins.left)
                        .attr("x2", xScale("Private") + xScale.bandwidth() / 2 + margins.left)
                        .attr("y1", chartHeight - margins.top)
                        .attr("y2", yScale(averagePrivateDBH))
                        .style("stroke", "forestgreen")
                        .style("stroke-width", 25);

                    chartArea.append("line")
                        .attr("x1", xScale("Public (DPW)") + xScale.bandwidth() / 2 + margins.left)
                        .attr("x2", xScale("Public (DPW)") + xScale.bandwidth() / 2 + margins.left)
                        .attr("y1", chartHeight - margins.top)
                        .attr("y2", yScale(averagePublicDBH))
                        .style("stroke", "purple")
                        .style("stroke-width", 25);

                    chartArea.append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 0 - margins.left)
                        .attr("x", 0 - (chartHeight / 2))
                        .attr("dy", "1em")
                        .style("text-anchor", "middle")
                        .text("Diameter at Breast Height (DBH)");
                }
            }
            requestData();

        </script>
    </div>
</body>

</html>